name: Build macOS App

on:
  workflow_dispatch:  # Cho phép chạy thủ công
  push:
    branches:
      - main
      - master
    paths:
      - 'run_server.py'
      - 'build_mac.sh'
      - '.github/workflows/build-mac.yml'

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Xcode Command Line Tools
      run: |
        xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
    
    - name: Install dependencies
      run: |
        python3.12 -m pip install --upgrade pip
        python3.12 -m pip install nuitka PySide6 requests urllib3
    
    - name: Convert PyQt6 to PySide6 (required for macOS)
      run: |
        echo "Converting PyQt6 to PySide6 for macOS compatibility..."
        if [ -f "convert_pyqt6_to_pyside6.py" ]; then
          python3.12 convert_pyqt6_to_pyside6.py run_server.py run_server_pyside6.py
          echo "Conversion successful"
        else
          echo "[!] Warning: convert_pyqt6_to_pyside6.py not found"
          echo "Creating basic conversion..."
          sed 's/PyQt6/PySide6/g; s/pyqtSignal/Signal/g' run_server.py > run_server_pyside6.py
        fi
        # Verify converted file
        if python3.12 -m py_compile run_server_pyside6.py 2>/dev/null; then
          echo "Converted file is valid"
        else
          echo "[!] Error: Converted file has syntax errors"
          exit 1
        fi
    
    - name: Build with Nuitka
      run: |
        chmod +x build_mac.sh
        ./build_mac.sh
    
    - name: Create .app bundle
      run: |
        if [ -f "create_mac_app.sh" ]; then
          chmod +x create_mac_app.sh
          ./create_mac_app.sh
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: KuroStudio-macOS
        path: |
          dist/KuroStudio
          dist/KuroStudio.app
        retention-days: 30
