name: Build macOS App

on:
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng
  push:
    branches:
      - main
      - master
    paths:
      - 'run_server.py'
      - 'build_mac.sh'
      - '.github/workflows/build-mac.yml'

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Xcode Command Line Tools
      run: |
        xcode-select --install || true
        sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer || true
    
    - name: Install dependencies
      run: |
        python3.12 -m pip install --upgrade pip
        python3.12 -m pip install nuitka PySide6 requests urllib3
    
    - name: Convert PyQt6 to PySide6 (required for macOS)
      run: |
        echo "Converting PyQt6 to PySide6 for macOS compatibility..."
        if [ -f "convert_pyqt6_to_pyside6.py" ]; then
          python3.12 convert_pyqt6_to_pyside6.py run_server.py run_server_pyside6.py
          echo "Conversion successful"
        else
          echo "[!] Warning: convert_pyqt6_to_pyside6.py not found"
          echo "Creating basic conversion..."
          sed 's/PyQt6/PySide6/g; s/pyqtSignal/Signal/g' run_server.py > run_server_pyside6.py
        fi
        # Verify converted file
        if python3.12 -m py_compile run_server_pyside6.py 2>/dev/null; then
          echo "Converted file is valid"
        else
          echo "[!] Error: Converted file has syntax errors"
          exit 1
        fi
    
    - name: Build with Nuitka
      run: |
        chmod +x build_mac.sh
        ./build_mac.sh
    
    - name: Create .app bundle
      run: |
        if [ -f "create_mac_app.sh" ]; then
          chmod +x create_mac_app.sh
          ./create_mac_app.sh
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: KuroStudio-macOS
        path: |
          dist/KuroStudio
          dist/KuroStudio.app
        retention-days: 30
    
    - name: Upload to Google Drive (optional)
      if: secrets.GDRIVE_SERVICE_ACCOUNT != ''
      env:
        GDRIVE_SERVICE_ACCOUNT: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        echo "Uploading to Google Drive..."
        python3.12 -m pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
        
        python3.12 << 'PYTHON_SCRIPT'
        import os
        import json
        import zipfile
        import sys
        from datetime import datetime
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        
        # Get credentials
        service_account_json = os.environ.get('GDRIVE_SERVICE_ACCOUNT', '')
        if not service_account_json:
            print("GDRIVE_SERVICE_ACCOUNT not set, skipping upload")
            sys.exit(0)
        
        try:
            service_account_info = json.loads(service_account_json)
        except:
            print("Invalid GDRIVE_SERVICE_ACCOUNT JSON, skipping upload")
            sys.exit(0)
        
        # Authenticate
        credentials = service_account.Credentials.from_service_account_info(
            service_account_info,
            scopes=['https://www.googleapis.com/auth/drive.file']
        )
        service = build('drive', 'v3', credentials=credentials)
        
        # Create zip file
        timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
        zip_filename = f'KuroStudio-macOS-{timestamp}.zip'
        
        with zipfile.ZipFile(zip_filename, 'w', zipfile.ZIP_DEFLATED) as zipf:
            if os.path.exists('dist/KuroStudio'):
                zipf.write('dist/KuroStudio', 'KuroStudio')
            if os.path.exists('dist/KuroStudio.app'):
                # Add .app bundle recursively
                for root, dirs, files in os.walk('dist/KuroStudio.app'):
                    for file in files:
                        file_path = os.path.join(root, file)
                        arcname = os.path.relpath(file_path, 'dist')
                        zipf.write(file_path, arcname)
        
        # Upload to Google Drive
        folder_id = os.environ.get('GDRIVE_FOLDER_ID', '')
        
        file_metadata = {
            'name': zip_filename,
        }
        if folder_id:
            file_metadata['parents'] = [folder_id]
        
        media = MediaFileUpload(zip_filename, mimetype='application/zip', resumable=True)
        file = service.files().create(body=file_metadata, media_body=media, fields='id,webViewLink').execute()
        
        print(f"âœ… Uploaded to Google Drive!")
        print(f"ðŸ“¦ File ID: {file.get('id')}")
        print(f"ðŸ”— Share link: {file.get('webViewLink')}")
        PYTHON_SCRIPT
